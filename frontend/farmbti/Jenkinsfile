pipeline {
    agent any

    tools {
        nodejs 'node18'
    }

    environment {
        GIT_CREDENTIALS_ID = 'gitlab-credentials'
        TARGET_DEPLOY_DIR = "/var/jenkins_home/app/frontend/farmbti"
        DOCKER_COMPOSE_PATH = "/usr/local/bin/docker-compose"
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: 'front']],
                    userRemoteConfigs: [[
                        url: 'https://lab.ssafy.com/s12-bigdata-dist-sub1/S12P21D209.git',
                        credentialsId: "${GIT_CREDENTIALS_ID}"
                    ]]
                ])
                sh 'echo "✅ 코드 체크아웃 완료"'
            }
        }

        stage('Build Frontend') {
            steps {
                dir("frontend/farmbti") {
                    sh '''
                    echo "✅ 프론트엔드 빌드 시작"
                    rm -rf node_modules dist
                    npm install --legacy-peer-deps
                    npm run build
                    echo "✅ 프론트엔드 빌드 완료"
                    '''
                }
            }
        }

        stage('Copy dist to Nginx target') {
            steps {
                sh '''
                echo "✅ 배포 디렉토리 준비"
                mkdir -p ${TARGET_DEPLOY_DIR}
                rm -rf ${TARGET_DEPLOY_DIR}/dist
                cp -r frontend/farmbti/dist ${TARGET_DEPLOY_DIR}/
                '''
            }
        }

        stage('Reload Nginx') {
            steps {
                dir('infra/nginx') {
                    sh '''
                    echo "✅ Nginx 컨테이너 재시작"
                    $DOCKER_COMPOSE_PATH down || true
                    $DOCKER_COMPOSE_PATH up -d
                    '''
                }
            }
        }
    }
}
