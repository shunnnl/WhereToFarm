pipeline {
    agent any

    environment {
        IMAGE_NAME = "nageum/s12p21d209_frontend"  // Docker Hub ì´ë¯¸ì§€ëª…
        CONTAINER_NAME = "farmbti-frontend"  // ì»¨í…Œì´ë„ˆ ì´ë¦„
        PORT = "3000"
        GIT_CREDENTIALS_ID = 'gitlab-credentials'  // GitLab ë¡œê·¸ì¸ ì •ë³´
        DOCKER_CREDENTIALS_ID = 'docker-hub'  // Docker Hub ë¡œê·¸ì¸ ì •ë³´
        NVM_DIR = "/home/ubuntu/.nvm"  // NVM ê²½ë¡œ ì„¤ì •
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/front']],  // front ë¸Œëœì¹˜ ì‚¬ìš©
                    userRemoteConfigs: [[
                        url: 'https://lab.ssafy.com/s12-bigdata-dist-sub1/S12P21D209.git',
                        credentialsId: "${GIT_CREDENTIALS_ID}"
                    ]]
                ])
            }
        }

        stage('Check Node.js & npm') {
            steps {
                sh '''
                echo "í ½í´ Checking Node.js & npm..."

                # NVM í™˜ê²½ ë¡œë“œ
                export NVM_DIR="$HOME/.nvm"
                [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
                [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

                # Node.js ë° npm ë²„ì „ í™•ì¸
                which node || echo "âŒ Node.js not found"
                which npm || echo "âŒ npm not found"
                node -v || echo "âŒ Failed to get Node.js version"
                npm -v || echo "âŒ Failed to get npm version"
                '''
            }
        }

        stage('Build Frontend') {
            steps {
                dir('frontend/farmbti') {
                    sh '''
                    #!/bin/bash
                    set -e
                    echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹œì‘"

                    # NVM í™˜ê²½ ë¡œë“œ
                    export NVM_DIR="$HOME/.nvm"
                    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
                    [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

                    # Node.js ë° npm í™•ì¸ í›„ ë¹Œë“œ ì‹¤í–‰
                    if ! command -v node &> /dev/null; then
                        echo "âŒ Node.jsê°€ ê°ì§€ë˜ì§€ ì•ŠìŒ. Node.jsë¥¼ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤."
                        exit 1
                    fi

                    if ! command -v npm &> /dev/null; then
                        echo "âŒ npmì´ ê°ì§€ë˜ì§€ ì•ŠìŒ. npmì„ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤."
                        exit 1
                    fi

                    node -v
                    npm -v

                    npm install
                    npm run build

                    echo "âœ… ë¹Œë“œ ì™„ë£Œ"
                    '''
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    echo "âœ… ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ë° ì‚­ì œ"
                    sh 'docker-compose -f frontend/farmbti/docker-compose.yml down || true'

                    echo "âœ… ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
                    sh 'docker-compose -f frontend/farmbti/docker-compose.yml up -d'

                    echo "âœ… ë°°í¬ ì™„ë£Œ"
                }
            }
        }
    }
}
